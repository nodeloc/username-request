(()=>{var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var s=t.n(e);const n=flarum.core.compat["common/models/User"];var r=t.n(n);const a=flarum.core.compat["common/Model"];var o=t.n(a);function i(t,e){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},i(t,e)}function u(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}const c=flarum.core.compat["common/utils/computed"];var l=t.n(c);const h=flarum.core.compat["common/utils/mixin"];var d=function(t){function e(){return t.apply(this,arguments)||this}return u(e,t),e}(t.n(h)()(o(),{user:o().hasOne("user"),status:o().attribute("status"),reason:o().attribute("reason"),createdAt:o().attribute("createdAt",o().transformDate),forNickname:o().attribute("forNickname"),_requestedUsername:o().attribute("requestedUsername"),requestedUsername:l()("_requestedUsername","forNickname","user",(function(t,e,s){return null===t&&e?s.username():t}))}));const p=flarum.core.compat["common/extend"],f=flarum.core.compat["common/components/Button"];var q=t.n(f);const v=flarum.core.compat["forum/components/SettingsPage"];var N=t.n(v);const b=flarum.core.compat["common/utils/Stream"];var y=t.n(b);const _=flarum.core.compat["common/components/Modal"];var g=t.n(_),k=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var n=e.prototype;return n.oninit=function(e){t.prototype.oninit.call(this,e),this.username=y()(this.attrs.nickname?s().session.user.displayName():s().session.user.username()),this.userRequestAttr="last"+(this.attrs.nickname?"Nickname":"Username")+"Request",this.lastRequest=s().session.user[this.userRequestAttr](),this.lastRequest&&this.username(this.lastRequest.requestedUsername()),this.success=!1,this.password=y()(""),this.translationPrefix="fof-username-request.forum."+(this.attrs.nickname?"nickname":"username")+"_modals.request",this.cost=this.attrs.nickname?s().forum.attribute("nickname_cost"):s().forum.attribute("username_cost")},n.className=function(){return"RequestUsernameModal Modal--small"},n.title=function(){return s().translator.trans(this.translationPrefix+".title")},n.content=function(){return this.success?m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},s().translator.trans(this.translationPrefix+".confirmation_message")),m("div",{className:"Form-group"},m(q(),{className:"Button Button--primary Button--block",onclick:this.hide.bind(this)},s().translator.trans(this.translationPrefix+".dismiss_button"))))):m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.lastRequest?m("p",{className:"helpText"},s().translator.trans(this.translationPrefix+".current_request",{name:this.lastRequest.requestedUsername()})):"",m("div",{className:"Form-group"},m("lable",null,s().translator.trans(this.translationPrefix+".cost",{cost:this.cost})),m("input",{type:"text",name:"text",className:"FormControl",placeholder:s().session.user.username(),bidi:this.username,disabled:this.deleteLoading||this.submitLoading})),s().forum.attribute("passwordlessSignUp")?null:m("div",{className:"Form-group"},m("input",{type:"password",name:"password",className:"FormControl",placeholder:s().translator.trans("core.forum.change_email.confirm_password_placeholder"),bidi:this.password,disabled:this.deleteLoading||this.submitLoading})),m("div",{className:"Form-group"},q().component({className:"Button Button--primary Button--block",type:"submit",loading:this.submitLoading},s().translator.trans(this.translationPrefix+".submit_button"))),this.lastRequest?m("div",{className:"Form-group"},q().component({className:"Button Button--primary Button--block",onclick:this.deleteRequest.bind(this),loading:this.deleteLoading},s().translator.trans(this.translationPrefix+".delete_button"))):""))},n.deleteRequest=function(t){t.preventDefault(),this.deleteLoading=!0,this.lastRequest.delete(),this.successAlert=s().alerts.show({type:"success"},s().translator.trans(this.translationPrefix+".deleted")),s().session.user[this.userRequestAttr]=y()(),this.hide()},n.onsubmit=function(t){var e=this;t.preventDefault(),this.alert=null;var n=this.attrs.nickname?s().session.user.displayName():s().session.user.username();this.username()!==n?(this.submitLoading=!0,s().store.createRecord("username-requests").save({username:this.username(),forNickname:this.attrs.nickname},{meta:{password:this.password()},errorHandler:this.onerror.bind(this)}).then((function(t){s().session.user[e.userRequestAttr]=y()(t),e.success=!0,e.alertAttrs=null})).catch((function(){})).then(this.loaded.bind(this))):this.hide()},n.onerror=function(e){401===e.status&&(e.alert.content=s().translator.trans("core.forum.change_email.incorrect_password_message"),this.submitLoading=!1),t.prototype.onerror.call(this,e)},e}(g());const x=flarum.core.compat["common/components/Page"];var R=t.n(x);const P=flarum.core.compat["common/Component"];var w=t.n(P);const A=flarum.core.compat["common/components/LoadingIndicator"];var U=t.n(A);const B=flarum.core.compat["common/helpers/avatar"];var F=t.n(B);const L=flarum.core.compat["common/helpers/username"];var M=t.n(L);const j=flarum.core.compat["common/helpers/icon"];var O=t.n(j);const C=flarum.core.compat["common/helpers/humanTime"];var T=t.n(C);const D=flarum.core.compat["common/utils/withAttr"];var S=t.n(D),H=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var n=e.prototype;return n.oninit=function(e){t.prototype.oninit.call(this,e),this.request=this.attrs.request,this.approved=y()("Rejected"),this.reason=y()(""),this.translationPrefix="fof-username-request.forum."+(this.request.forNickname()?"nickname":"username")+"_modals.action"},n.title=function(){return s().translator.trans(this.translationPrefix+".title")},n.className=function(){return"RequestActionModal Modal--medium"},n.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("h3",{className:"Notification-content"},s().translator.trans(this.translationPrefix+".name",{name:M()(this.request.user()),requestedName:this.request.requestedUsername()})),m("p",{className:"help"},s().translator.trans(this.translationPrefix+".help_text")),m("legend",null,s().translator.trans(this.translationPrefix+".decision_title")),m("div",{className:"Form-group"},m("label",{className:"checkbox"},m("input",{type:"radio",name:"approved",value:"Approved",checked:"Approved"===this.approved(),onclick:S()("value",this.approved)}),s().translator.trans(this.translationPrefix+".approval_label")),m("label",{className:"checkbox"},m("input",{type:"radio",name:"rejected",value:"Rejected",checked:"Rejected"===this.approved(),onclick:S()("value",this.approved)}),s().translator.trans(this.translationPrefix+".rejected_label"))),"Rejected"===this.approved()?m("div",{className:"Form-group"},m("legend",null,s().translator.trans(this.translationPrefix+".reason_title")),m("div",{className:"BasicsPage-reason-input"},m("textarea",{className:"FormControl",value:this.reason(),disabled:this.loading,oninput:S()("value",this.reason)}))):"",m("div",{className:"Form-group"},q().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading,disabled:"Rejected"===this.approved()&&!this.reason()},s().translator.trans(this.translationPrefix+".submit_button")))))},n.onsubmit=function(t){var e=this;t.preventDefault(),this.loading=!0,this.request.save({reason:this.reason(),action:this.approved()}).then((function(){e.successAlert=s().alerts.show({type:"success"},s().translator.trans(e.translationPrefix+".success"))})),s().cache.username_requests.some((function(t,n){t.id()==e.request.id()&&s().cache.username_requests.splice(n,1)})),m.redraw(),this.hide()},e}(g()),I=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var n=e.prototype;return n.oninit=function(e){t.prototype.oninit.call(this,e),this.loading=!1},n.view=function(){var t=this,e=s().cache.username_requests||[];return m("div",{className:"NotificationList RequestsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},s().translator.trans("fof-username-request.forum.pending_requests.title"))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},e.length?e.map((function(e){var n=e.forNickname()?"nickname":"username";return m("li",null,m("a",{onclick:t.showModal.bind(t,e),className:"Notification Request"},F()(e.user()),O()("fas fa-user-edit",{className:"Notification-icon"}),m("span",{className:"Notification-content"},s().translator.trans("fof-username-request.forum.pending_requests."+n+"_item_text",{name:M()(e.user())})),T()(e.createdAt()),m("div",{className:"Notification-excerpt"},s().translator.trans("fof-username-request.forum.pending_requests."+n+"_exerpt",{requestedName:e.requestedUsername()}))))})):this.loading?U().component({className:"LoadingIndicator--block"}):m("div",{className:"NotificationList-empty"},s().translator.trans("fof-username-request.forum.pending_requests.empty_text")))))},n.showModal=function(t){s().modal.show(H,{request:t})},e}(w()),G=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var n=e.prototype;return n.oninit=function(e){t.prototype.oninit.call(this,e),s().history.push("requests"),s().usernameRequests.load(),this.bodyClass="App--requests"},n.view=function(){return m("div",{className:"RequestsPage"},m(I,{state:s().usernameRequests}))},e}(R());const z=flarum.core.compat["forum/components/HeaderSecondary"];var E=t.n(z);const J=flarum.core.compat["forum/components/NotificationsDropdown"];var K=function(t){function e(){return t.apply(this,arguments)||this}u(e,t),e.initAttrs=function(e){e.label=e.label||s().translator.trans("fof-username-request.forum.pending_requests.tooltip"),e.icon=e.icon||"fas fa-user-edit",t.initAttrs.call(this,e)};var n=e.prototype;return n.getMenu=function(){return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName,onclick:this.menuClick.bind(this)},this.showing?I.component({state:s().usernameRequests}):"")},n.goToRoute=function(){m.route.set(s().route("username_requests"))},n.getUnreadCount=function(){return s().cache.username_requests?s().cache.username_requests.length:s().forum.data.relationships.username_requests.data.length},n.getNewCount=function(){return s().cache.username_requests?s().cache.username_requests.length:s().forum.data.relationships.username_requests.data.length},e}(t.n(J)()),Q=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var n=e.prototype;return n.oninit=function(e){t.prototype.oninit.call(this,e),this.userRequestAttr="last"+(this.attrs.nickname?"Nickname":"Username")+"Request",this.request=s().session.user[this.userRequestAttr](),this.translationPrefix="fof-username-request.forum."+(this.request.forNickname()?"nickname":"username")+"_modals.results"},n.className=function(){return"ResultsModal Modal"},n.title=function(){return s().translator.trans(this.translationPrefix+".title")},n.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},"Approved"===this.request.status()?[m("h2",null,s().translator.trans(this.translationPrefix+".approved")),m("h3",null,s().translator.trans(this.translationPrefix+".new_name",{name:s().session.user.displayName()}))]:[m("h2",null,s().translator.trans(this.translationPrefix+".rejected")),m("h3",null,s().translator.trans(this.translationPrefix+".reason",{reason:this.request.reason(),i:m("i",null)})),m("p",{className:"helpText"},s().translator.trans(this.translationPrefix+".resubmit"))],m("div",{className:"Form-group"},m(q(),{className:"Button Button--primary Button--block",onclick:this.hide.bind(this)},s().translator.trans(this.translationPrefix+".dismiss_button")))))},n.onremove=function(){s().session.user[this.userRequestAttr]=y()(),this.request.save({delete:!0})},e}(g());const V=flarum.core.compat["forum/components/UserPage"];var W=t.n(V),X=function(t){function e(){return t.apply(this,arguments)||this}u(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.loading=!0,this.loadUser(m.route.param("username"))},s.content=function(){var t=this;return m("table",{className:"NotificationGrid"},this.user.usernameHistory().slice(0).reverse().map((function(e){var s=Object.keys(e)[0];return m("tr",null,m("td",null,s),m("td",null,T()(t.calculateTime(e[s]))))})))},s.show=function(t){this.user=t,m.redraw()},s.calculateTime=function(t){return new Date(0).setUTCSeconds(t)},e}(W());const Y=flarum.core.compat["common/components/LinkButton"];var Z=t.n(Y),$=function(){function t(t){this.app=t,this.loading=!1,this.cache=[]}return t.prototype.load=function(){var t=this;s().cache.username_requests||(this.loading=!0,m.redraw(),s().store.find("username-requests").then((function(t){delete t.payload,s().cache.username_requests=t.sort((function(t,e){return t.createdAt()-e.createdAt()}))})).catch((function(){})).then((function(){t.loading=!1,m.redraw()})))},t}();s().initializers.add("fof-username-request",(function(){s().store.models["username-requests"]=d,r().prototype.lastNicknameRequest=o().hasOne("lastNicknameRequest"),r().prototype.lastUsernameRequest=o().hasOne("lastUsernameRequest"),r().prototype.usernameHistory=o().attribute("usernameHistory"),s().routes.username_requests={path:"/username-requests",component:G},s().routes.username_history={path:"/u/:username/history",component:X},s().usernameRequests=new $(s()),(0,p.extend)(N().prototype,"accountItems",(function(t){s().forum.attribute("canRequestUsername")&&t.add("username-request",q().component({className:"Button",onclick:function(){s().modal.show(k)}},s().translator.trans("fof-username-request.forum.settings.username_request_button")),8),"nickname"===s().forum.attribute("displayNameDriver")&&s().forum.attribute("canRequestNickname")&&!this.user.attribute("canEditOwnNickname")&&"flarum-nicknames"in flarum.extensions&&t.add("nickname-request",q().component({className:"Button",onclick:function(){s().modal.show(k,{nickname:!0})}},s().translator.trans("fof-username-request.forum.settings.nickname_request_button")),8)})),(0,p.extend)(E().prototype,"items",(function(t){(s().forum.data.relationships.username_requests&&s().forum.data.relationships.username_requests.data.length&&!s().cache.username_requests||s().cache.username_requests&&0!==s().cache.username_requests.length)&&t.add("UsernameRequests",m(K,{state:s().usernameRequests}),20)})),new Promise((function(){setTimeout((function(){if(s().session.user){var t=s().session.user.lastNicknameRequest()&&"Sent"!==s().session.user.lastNicknameRequest().status(),e=s().session.user.lastUsernameRequest()&&"Sent"!==s().session.user.lastUsernameRequest().status();(t||e)&&s().modal.show(Q,{nickname:t})}}),1e3)})),(0,p.extend)(W().prototype,"navItems",(function(t){this.user.usernameHistory()&&t.add("username-requests",Z().component({href:s().route("username_history",{username:this.user.slug()}),icon:"fas fa-user-edit"},s().translator.trans("fof-username-request.forum.user.name_history_link")))}))}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map